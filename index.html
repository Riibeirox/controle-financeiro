<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Controle Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; }
main { max-width:1200px; margin:30px auto; background:#fff; padding:24px; border-radius:12px; }
h1,h2 { margin-top:0 }

.tabs { display:flex; gap:10px; margin-bottom:20px; }
.tabs button {
  padding:10px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#e5e7eb;
}
.tabs button.active {
  background:#0b2545;
  color:#fff;
}

.grid { display:grid; grid-template-columns: repeat(5,1fr); gap:12px; }

input, select, button {
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
}

button {
  background:#0b2545;
  color:#fff;
  cursor:pointer;
}

button.sec { background:#374151; }
button.edit { background:#1d4ed8; }
button.del { background:#b91c1c; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:16px;
}

th, td {
  border-bottom:1px solid #ddd;
  padding:8px;
  text-align:left;
}

.cards {
  display:flex;
  gap:16px;
  margin:20px 0;
}

.card {
  flex:1;
  padding:16px;
  border-radius:12px;
  background:#eef2ff;
  font-size:16px;
}

.ok { background:#dcfce7; }
.warn { background:#fef9c3; }
.bad { background:#fee2e2; }

.hidden { display:none; }
</style>
</head>

<body>
<main>

<h1>Controle Financeiro</h1>

<div class="tabs">
  <button class="active" id="btnLanc">Lançamentos</button>
  <button id="btnAnalise">Análise Mensal</button>
</div>

<!-- ================= LANCAMENTOS ================= -->
<section id="lanc">

<div class="grid">
  <input type="date" id="data">
  <input type="number" id="valor" placeholder="Valor" step="0.01">
  <select id="tipo">
    <option value="Despesa">Despesa</option>
    <option value="Receita">Receita</option>
  </select>
  <select id="natureza"></select>
  <input type="month" id="filtroMes">
</div>

<div style="margin-top:12px">
  <button onclick="adicionar()">Adicionar / Atualizar</button>
  <button class="sec" onclick="salvarBanco()">Salvar no banco</button>
</div>

<div class="cards">
  <div class="card">Receitas<br><strong>R$ <span id="totRec">0.00</span></strong></div>
  <div class="card">Despesas<br><strong>R$ <span id="totDes">0.00</span></strong></div>
  <div class="card">Saldo<br><strong>R$ <span id="saldo">0.00</span></strong></div>
</div>

<table>
<thead>
<tr>
  <th>Data</th><th>Tipo</th><th>Natureza</th><th>Valor</th><th>Ações</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>

<!-- ================= ANALISE ================= -->
<section id="analise" class="hidden">

<div class="grid">
  <input type="month" id="mesAnalise">
  <button onclick="buscarAnalise()">Buscar</button>
</div>

<div class="cards">
  <div class="card">Receitas<br><strong>R$ <span id="aRec">0.00</span></strong></div>
  <div class="card">Despesas<br><strong>R$ <span id="aDes">0.00</span></strong></div>
  <div class="card">Saldo<br><strong>R$ <span id="aSaldo">0.00</span></strong></div>
</div>

<h2>Despesas x Orçamento</h2>
<table>
<thead>
<tr>
  <th>Natureza</th>
  <th>Gasto</th>
  <th>Orçamento</th>
  <th>%</th>
</tr>
</thead>
<tbody id="tabOrcamento"></tbody>
</table>

</section>

</main>

<script>
/* ================= CONFIG ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycbxk5OkkTTuijxcrPTxP9wcLonVzVWFsHqCEyW2QFV2YGbOFZIDfg5pFWhIgbqiy1pDP/exec";

const naturezas = [
"Adiantamento","Salário","Décimo","Renda Extra",
"Condominio e gás","Taxa extra","Alimentação (mercado)","Almoço",
"Conta de Luz","Gasolina","Cartão XP","Cartão Nubank","Internet",
"IPTU","Vento Divino","Celulares","Jiujitsu","Escola Aurora",
"Dentista","Seguro","Lavagem carro","Nina","Farmacia",
"Viagem Itabuna","Aquários","Lazer","Extraordinárias","Outros","Investimentos"
];

const naturezaSel = document.getElementById("natureza");
naturezas.forEach(n => {
  const op = document.createElement("option");
  op.textContent = n;
  naturezaSel.appendChild(op);
});

data.valueAsDate = new Date();

/* ================= TABS ================= */
const secLanc = document.getElementById("lanc");
const secAnalise = document.getElementById("analise");

document.getElementById("btnLanc").onclick = () => {
  secLanc.classList.remove("hidden");
  secAnalise.classList.add("hidden");
  btnLanc.classList.add("active");
  btnAnalise.classList.remove("active");
};

document.getElementById("btnAnalise").onclick = () => {
  secLanc.classList.add("hidden");
  secAnalise.classList.remove("hidden");
  btnAnalise.classList.add("active");
  btnLanc.classList.remove("active");
};

/* ================= LANCAMENTOS ================= */
let lancamentos = [];
let editIndex = null;

function adicionar() {
  const obj = {
    d: data.value,
    v: Number(valor.value),
    t: tipo.value,
    n: natureza.value
  };

  if (!obj.d || !obj.v) {
    alert("Preencha data e valor");
    return;
  }

  if (editIndex !== null) {
    lancamentos[editIndex] = obj;
    editIndex = null;
  } else {
    lancamentos.push(obj);
  }

  valor.value = "";
  renderLanc();
}

function editar(i) {
  const l = lancamentos[i];
  data.value = l.d;
  valor.value = l.v;
  tipo.value = l.t;
  natureza.value = l.n;
  editIndex = i;
}

function remover(i) {
  lancamentos.splice(i, 1);
  renderLanc();
}

function renderLanc() {
  let tr = 0, td = 0;
  lista.innerHTML = "";

  lancamentos.forEach((l, i) => {
    l.t === "Receita" ? tr += l.v : td += l.v;

    lista.innerHTML += `
      <tr>
        <td>${l.d}</td>
        <td>${l.t}</td>
        <td>${l.n}</td>
        <td>R$ ${l.v.toFixed(2)}</td>
        <td>
          <button class="edit" onclick="editar(${i})">Editar</button>
          <button class="del" onclick="remover(${i})">Excluir</button>
        </td>
      </tr>`;
  });

  totRec.textContent = tr.toFixed(2);
  totDes.textContent = td.toFixed(2);
  saldo.textContent = (tr - td).toFixed(2);
}

function salvarBanco() {
  if (!lancamentos.length) {
    alert("Nada para salvar");
    return;
  }

  const receitas = [], despesas = [];

  lancamentos.forEach(l => {
    const r = [l.d, l.v, l.n];
    l.t === "Receita" ? receitas.push(r) : despesas.push(r);
  });

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: "saveBatch",
      receitas,
      despesas
    })
  })
  .then(r => r.json())
  .then(j => {
    if (j.status === "ok") {
      alert("Salvo com sucesso!");
      lancamentos = [];
      renderLanc();
    } else {
      alert(j.payload || j.msg || "Erro ao salvar");
    }
  })
  .catch(() => alert("Erro de conexão"));
}

/* ================= ANALISE ================= */
function buscarAnalise() {
  const mes = document.getElementById("mesAnalise").value;
  if (!mes) {
    alert("Selecione o mês");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: "getByMonth",
      mes
    })
  })
  .then(r => r.json())
  .then(j => {
    if (j.status !== "ok") {
      alert(j.payload || j.msg || "Erro ao buscar dados");
      return;
    }

    montarAnalise(
      j.payload.receitas || [],
      j.payload.despesas || [],
      j.payload.orcamentos || []
    );
  })
  .catch(() => alert("Erro de conexão com o Google Sheets"));
}

function montarAnalise(receitas, despesas, orcamentos) {
  let totalRec = 0, totalDes = 0;

  receitas.forEach(r => totalRec += Number(r[1] || 0));
  despesas.forEach(d => totalDes += Number(d[1] || 0));

  aRec.textContent = totalRec.toFixed(2);
  aDes.textContent = totalDes.toFixed(2);
  aSaldo.textContent = (totalRec - totalDes).toFixed(2);

  const gastoPorNatureza = {};
  despesas.forEach(d => {
    gastoPorNatureza[d[2]] = (gastoPorNatureza[d[2]] || 0) + Number(d[1]);
  });

  const orcPorNatureza = {};
  orcamentos.forEach(o => {
    orcPorNatureza[o[0]] = Number(o[1] || 0);
  });

  tabOrcamento.innerHTML = "";

  Object.keys(gastoPorNatureza).forEach(n => {
    const gasto = gastoPorNatureza[n];
    const orc = orcPorNatureza[n] || 0;
    const pct = orc > 0 ? (gasto / orc) * 100 : 0;

    let cls = "ok";
    if (pct >= 90) cls = "bad";
    else if (pct >= 70) cls = "warn";

    tabOrcamento.innerHTML += `
      <tr class="${cls}">
        <td>${n}</td>
        <td>R$ ${gasto.toFixed(2)}</td>
        <td>R$ ${orc.toFixed(2)}</td>
        <td>${pct.toFixed(0)}%</td>
      </tr>`;
  });
}
</script>

</body>
</html>
