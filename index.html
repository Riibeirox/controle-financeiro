<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Controle Financeiro Familiar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; }
main { max-width:1200px; margin:30px auto; background:#fff; padding:24px; border-radius:12px; }
h1,h2 { margin-top:0 }

.tabs { display:flex; gap:10px; margin-bottom:20px; }
.tabs button {
  padding:10px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#e5e7eb;
}
.tabs button.active {
  background:#0b2545;
  color:#fff;
}

.grid { display:grid; grid-template-columns: repeat(5,1fr); gap:12px; }

input, select, button {
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
}

button { background:#0b2545; color:#fff; cursor:pointer; }
button.sec { background:#374151; }
button.edit { background:#1d4ed8; }
button.del { background:#b91c1c; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:16px;
}
th, td { border-bottom:1px solid #ddd; padding:8px; }

.cards { display:flex; gap:16px; margin:20px 0; }
.card {
  flex:1;
  padding:16px;
  border-radius:12px;
  background:#eef2ff;
}

.ok { background:#dcfce7; }
.warn { background:#fef9c3; }
.bad { background:#fee2e2; }

.hidden { display:none; }

/* =========================
   RESPONSIVIDADE MOBILE
========================= */
@media (max-width: 768px) {

  main {
    margin: 10px;
    padding: 16px;
  }

  /* Tabs */
  .tabs {
    flex-direction: column;
  }

  .tabs button {
    width: 100%;
    font-size: 16px;
  }

  /* Formulários */
  .grid {
    grid-template-columns: 1fr;
  }

  input, select, button {
    font-size: 16px;
  }

  /* Cards */
  .cards {
    flex-direction: column;
  }

  .card {
    font-size: 15px;
  }

  /* Tabelas com rolagem */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  th, td {
    font-size: 14px;
    padding: 10px 8px;
  }

  /* Botões de ação */
  button.edit,
  button.del {
    padding: 8px 12px;
    font-size: 14px;
  }

  /* Barra de orçamento */
  #barraOrc {
    transition: width 0.3s ease;
  }
}

</style>
</head>

<body>
<main>

<h1>Controle Financeiro Familiar</h1>

<div class="tabs">
  <button class="active" id="btnLanc">Lançamentos</button>
  <button id="btnAnalise">Análise Mensal</button>
</div>

<!-- ================= LANCAMENTOS ================= -->
<section id="lanc">

<div class="grid">
  <input type="date" id="data">
  <input type="number" id="valor" placeholder="Valor" step="0.01">
  <select id="tipo">
    <option value="Despesa">Despesa</option>
    <option value="Receita">Receita</option>
  </select>
  <select id="natureza"></select>
  <input type="month" id="filtroMes">
</div>

<div style="margin-top:12px">
  <button onclick="adicionar()">Adicionar / Atualizar</button>
  <button class="sec" onclick="salvarBanco()">Salvar no banco</button>
</div>

<div class="cards">
  <div class="card">Receitas<br><strong>R$ <span id="totRec">0.00</span></strong></div>
  <div class="card">Despesas<br><strong>R$ <span id="totDes">0.00</span></strong></div>
  <div class="card">Saldo<br><strong>R$ <span id="saldo">0.00</span></strong></div>
</div>

<table>
<thead>
<tr>
  <th>Data</th><th>Tipo</th><th>Natureza</th><th>Valor</th><th>Ações</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</section>

<!-- ================= ANALISE ================= -->
<section id="analise" class="hidden">

<div class="grid">
  <input type="month" id="mesAnalise">
  <button onclick="buscarAnalise()">Buscar</button>
</div>

<div class="cards">
  <div class="card">Receitas<br><strong>R$ <span id="aRec">0.00</span></strong></div>
  <div class="card">Despesas<br><strong>R$ <span id="aDes">0.00</span></strong></div>
  <div class="card">Saldo<br><strong>R$ <span id="aSaldo">0.00</span></strong></div>
  <div class="card" id="cardPct">Orçamento Consumido<br>
    <strong><span id="pctOrc">0%</span></strong>
  </div>
</div>

<div style="margin:10px 0">
  <div style="background:#e5e7eb;border-radius:8px;height:16px;overflow:hidden">
    <div id="barraOrc" style="height:100%;width:0%;background:#16a34a"></div>
  </div>
</div>

<div style="margin-bottom:20px">
  <strong>Variação vs mês anterior:</strong>
  <span id="varMes">—</span>
</div>

<h2>Despesas x Orçamento</h2>

<table>
<thead>
<tr>
  <th>Natureza</th><th>Gasto</th><th>Orçamento</th><th>%</th>
</tr>
</thead>
<tbody id="tabOrcamento"></tbody>
<tfoot id="totOrcamento"></tfoot>
</table>

</section>
</main>

<script>
/* ================= API ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxXqRmTapb4E0wG8gGFejQ6qWtkTQnXji2Nh4IK4ADaSLqpxMkjgH9d2C-YzHxY1mnS/exec";

/* ================= CONFIG ================= */
const naturezas = [
"Adiantamento","Salário","Décimo","Renda Extra",
"Condominio e gás","Taxa extra","Alimentação (mercado)","Almoço","Padaria",
"Conta de Luz","Gasolina","Cartão XP","Cartão Nubank","Internet",
"IPTU","Vento Divino","Celulares","Jiujitsu","Escola Aurora",
"Dentista","Seguro","Lavagem carro","Nina","Farmacia",
"Viagem Itabuna","Aquários","Lazer","Extraordinárias","Outros","Investimentos"
];
naturezas.forEach(n => natureza.appendChild(new Option(n,n)));
data.valueAsDate = new Date();

/* ================= TABS ================= */
btnLanc.onclick = () => {
  lanc.classList.remove("hidden");
  analise.classList.add("hidden");
  btnLanc.classList.add("active");
  btnAnalise.classList.remove("active");
};
btnAnalise.onclick = () => {
  lanc.classList.add("hidden");
  analise.classList.remove("hidden");
  btnAnalise.classList.add("active");
  btnLanc.classList.remove("active");
};

/* ================= LANCAMENTOS ================= */
let lancamentos = [], editIndex = null;

function adicionar(){
  if(!data.value || !valor.value) return alert("Preencha data e valor");
  const obj = { d:data.value, v:+valor.value, t:tipo.value, n:natureza.value };
  editIndex !== null ? lancamentos[editIndex] = obj : lancamentos.push(obj);
  editIndex = null;
  valor.value = "";
  renderLanc();
}

function editar(i){
  const l = lancamentos[i];
  data.value = l.d;
  valor.value = l.v;
  tipo.value = l.t;
  natureza.value = l.n;
  editIndex = i;
}

function remover(i){
  lancamentos.splice(i,1);
  renderLanc();
}

function renderLanc(){
  let r=0,d=0;
  lista.innerHTML="";
  lancamentos.forEach((l,i)=>{
    l.t==="Receita" ? r+=l.v : d+=l.v;
    lista.innerHTML += `
      <tr>
        <td>${l.d}</td>
        <td>${l.t}</td>
        <td>${l.n}</td>
        <td>R$ ${l.v.toFixed(2)}</td>
        <td>
          <button class="edit" onclick="editar(${i})">Editar</button>
          <button class="del" onclick="remover(${i})">Excluir</button>
        </td>
      </tr>`;
  });
  totRec.textContent = r.toFixed(2);
  totDes.textContent = d.toFixed(2);
  saldo.textContent = (r-d).toFixed(2);
}

function salvarBanco(){
  if(!lancamentos.length) return alert("Nada para salvar");
  const receitas=[], despesas=[];
  lancamentos.forEach(l=>{
    const r=[l.d,l.v,l.n];
    l.t==="Receita" ? receitas.push(r) : despesas.push(r);
  });
  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({action:"saveBatch",receitas,despesas})
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status==="ok"){
      alert("Salvo com sucesso!");
      lancamentos=[];
      renderLanc();
    } else alert(j.payload||"Erro");
  });
}

/* ================= ANALISE ================= */
function buscarAnalise(){
  if(!mesAnalise.value) return alert("Selecione o mês");
  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({action:"getByMonth",mes:mesAnalise.value})
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=="ok") return alert(j.payload||"Erro");
    montarAnalise(
      j.payload.receitas||[],
      j.payload.despesas||[],
      j.payload.orcamentos||[],
      j.payload.despesasAnterior||[]
    );
  });
}

function montarAnalise(rec, des, orc, desAnt){

  /* ===== RESUMO MENSAL ===== */
  const totalRec = rec.reduce((s,r)=>s+Number(r[1]||0),0);
  const totalDes = des.reduce((s,d)=>s+Number(d[1]||0),0);

  aRec.textContent = totalRec.toFixed(2);
  aDes.textContent = totalDes.toFixed(2);
  aSaldo.textContent = (totalRec - totalDes).toFixed(2);

  /* ===== DESPESAS x ORÇAMENTO ===== */
  let tg=0,to=0;
  tabOrcamento.innerHTML="";
  totOrcamento.innerHTML="";
  const g={}, o={};

  des.forEach(d=>g[d[2]]=(g[d[2]]||0)+Number(d[1]));
  orc.forEach(x=>o[x[0]]=Number(x[1]));

  Object.keys(g).forEach(n=>{
    const ga=g[n], orcV=o[n]||0;
    const p=orcV?ga/orcV*100:0;
    tg+=ga; to+=orcV;
    const c=p>=90?"bad":p>=70?"warn":"ok";
    tabOrcamento.innerHTML+=`
      <tr class="${c}">
        <td>${n}</td>
        <td>R$ ${ga.toFixed(2)}</td>
        <td>R$ ${orcV.toFixed(2)}</td>
        <td>${p.toFixed(0)}%</td>
      </tr>`;
  });

  const pg=to?tg/to*100:0;
  const cg=pg>=90?"bad":pg>=70?"warn":"ok";
  totOrcamento.innerHTML=`
    <tr class="${cg}" style="font-weight:bold">
      <td>Total Geral</td>
      <td>R$ ${tg.toFixed(2)}</td>
      <td>R$ ${to.toFixed(2)}</td>
      <td>${pg.toFixed(0)}%</td>
    </tr>`;

  pctOrc.textContent = pg.toFixed(0)+"%";
  cardPct.className = "card "+cg;
  barraOrc.style.width = Math.min(pg,100)+"%";
  barraOrc.style.background = pg>=90?"#dc2626":pg>=70?"#f59e0b":"#16a34a";

  /* ===== MÊS ANTERIOR ===== */
  const ant = desAnt.reduce((s,d)=>s+Number(d[1]||0),0);
  if(ant){
    const diff = tg-ant;
    varMes.textContent = (diff>0?"▲ ":"▼ ")+"R$ "+Math.abs(diff).toFixed(2);
    varMes.style.color = diff>0?"#dc2626":"#16a34a";
  } else {
    varMes.textContent = "Sem histórico";
  }
}
</script>
</body>
</html>

