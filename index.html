<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Controle Financeiro Familiar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f3f4f6; margin:0; }
main { max-width:1300px; margin:30px auto; background:#fff; padding:24px; border-radius:12px; }
h1,h2 { margin-top:0 }
.tabs { display:flex; gap:10px; margin-bottom:20px; }
.tabs button {
  padding:10px 16px; border:none; border-radius:8px;
  cursor:pointer; background:#e5e7eb;
}
.tabs button.active { background:#0b2545; color:#fff; }

.grid { display:grid; grid-template-columns: repeat(5,1fr); gap:12px; }
input,select,button {
  padding:10px; border-radius:8px; border:1px solid #ccc;
}
button { background:#0b2545; color:#fff; cursor:pointer; }
button.sec { background:#374151; }
button.edit { background:#1d4ed8; }
button.del { background:#b91c1c; }

table { width:100%; border-collapse:collapse; margin-top:16px; }
th,td { border-bottom:1px solid #ddd; padding:8px; }

.cards { display:flex; gap:16px; margin:20px 0; }
.card {
  flex:1; padding:16px; border-radius:12px;
  background:#eef2ff; font-size:16px;
}

.hidden { display:none; }
.ok { background:#dcfce7; }
.warn { background:#fef9c3; }
.bad { background:#fee2e2; }
</style>
</head>

<body>
<main>

<h1>Controle Financeiro</h1>

<div class="tabs">
  <button class="active" onclick="showTab('lanc')">Lançamentos</button>
  <button onclick="showTab('analise')">Análise Mensal</button>
  <button onclick="showTab('orc')">Orçamento</button>
</div>

<!-- ================= LANCAMENTOS ================= -->
<section id="lanc">

<div class="grid">
  <input type="date" id="data">
  <input type="number" id="valor" placeholder="Valor" step="0.01">
  <select id="tipo">
    <option value="Despesa">Despesa</option>
    <option value="Receita">Receita</option>
  </select>
  <select id="natureza"></select>
  <input type="month" id="filtroMes">
</div>

<div style="margin-top:12px">
  <button onclick="adicionar()">Adicionar / Atualizar</button>
  <button class="sec" onclick="salvarBanco()">Salvar no banco</button>
</div>

<div class="cards">
  <div class="card">Receitas<br><strong>R$ <span id="totRec">0</span></strong></div>
  <div class="card">Despesas<br><strong>R$ <span id="totDes">0</span></strong></div>
  <div class="card">Saldo<br><strong>R$ <span id="saldo">0</span></strong></div>
</div>

<table>
<thead>
<tr>
  <th>Data</th><th>Tipo</th><th>Natureza</th><th>Valor</th><th>Ações</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</section>

<!-- ================= ANALISE ================= -->
<section id="analise" class="hidden">

<div class="grid">
  <input type="month" id="mesAnalise">
  <button onclick="buscarAnalise()">Buscar</button>
</div>

<div class="cards">
  <div class="card">Receitas<br><strong>R$ <span id="aRec">0</span></strong></div>
  <div class="card">Despesas<br><strong>R$ <span id="aDes">0</span></strong></div>
  <div class="card">Saldo<br><strong>R$ <span id="aSaldo">0</span></strong></div>
</div>

<h2>Despesas x Orçamento</h2>
<table>
<thead>
<tr>
  <th>Natureza</th>
  <th>Gasto</th>
  <th>Orçamento</th>
  <th>%</th>
</tr>
</thead>
<tbody id="tabOrcamento"></tbody>
</table>

</section>

<!-- ================= ORCAMENTO ================= -->
<section id="orc" class="hidden">

<div class="grid">
  <select id="orcNatureza"></select>
  <input type="number" id="orcValor" placeholder="Valor mensal">
  <button onclick="salvarOrcamento()">Salvar orçamento</button>
</div>

<table>
<thead>
<tr><th>Natureza</th><th>Valor</th></tr>
</thead>
<tbody id="listaOrc"></tbody>
</table>

</section>

</main>

<script>
/* ================= CONFIG ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycbzGZr1rj0CR3L7EdaFvXTMdqyscl019v1Q8VCdRNBJklB2O9C3xFjG-wWYh2qos5973/exec";

const naturezas = [
"Adiantamento","Salário","Décimo","Renda Extra",
"Condominio e gás","Taxa extra","Alimentação (mercado)","Almoço",
"Conta de Luz","Gasolina","Cartão XP","Cartão Nubank","Internet",
"IPTU","Vento Divino","Celulares","Jiujitsu","Escola Aurora",
"Dentista","Seguro","Lavagem carro","Nina","Farmacia",
"Viagem Itabuna","Aquários","Lazer","Extraordinárias","Outros","Investimentos"
];

naturezas.forEach(n=>{
  natureza.innerHTML+=`<option>${n}</option>`;
  orcNatureza.innerHTML+=`<option>${n}</option>`;
});

data.valueAsDate=new Date();

/* ================= TABS ================= */
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}

/* ================= LANCAMENTOS ================= */
let lancamentos=[], editIndex=null;

function adicionar(){
  const obj={ d:data.value, v:+valor.value, t:tipo.value, n:natureza.value };
  if(!obj.d||!obj.v) return alert("Preencha data e valor");
  if(editIndex!==null){ lancamentos[editIndex]=obj; editIndex=null; }
  else lancamentos.push(obj);
  valor.value=""; renderLanc();
}

function editar(i){
  const l=lancamentos[i];
  data.value=l.d; valor.value=l.v; tipo.value=l.t; natureza.value=l.n;
  editIndex=i;
}

function remover(i){ lancamentos.splice(i,1); renderLanc(); }

function renderLanc(){
  let tr=0, td=0;
  lista.innerHTML="";
  lancamentos.forEach((l,i)=>{
    if(l.t==="Receita") tr+=l.v; else td+=l.v;
    lista.innerHTML+=`
      <tr>
        <td>${l.d}</td><td>${l.t}</td><td>${l.n}</td>
        <td>R$ ${l.v.toFixed(2)}</td>
        <td>
          <button class="edit" onclick="editar(${i})">Editar</button>
          <button class="del" onclick="remover(${i})">Del</button>
        </td>
      </tr>`;
  });
  totRec.textContent=tr.toFixed(2);
  totDes.textContent=td.toFixed(2);
  saldo.textContent=(tr-td).toFixed(2);
}

function salvarBanco(){
  const receitas=[], despesas=[];
  lancamentos.forEach(l=>{
    const r=[l.d,l.v,l.n];
    l.t==="Receita" ? receitas.push(r) : despesas.push(r);
  });
  fetch(API_URL,{
    method:"POST", headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({ action:"saveBatch", receitas, despesas })
  })
  .then(r=>r.json()).then(j=>{
    if(j.status==="ok"){ alert("Salvo!"); lancamentos=[]; renderLanc(); }
    else alert(j.payload||j.msg);
  });
}

/* ================= ANALISE ================= */
function buscarAnalise(){
  fetch(API_URL,{
    method:"POST", headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({ action:"getByMonth", mes:mesAnalise.value })
  })
  .then(r=>r.json()).then(j=>{
    if(j.status!=="ok") return alert("Erro");
    carregarOrcamentos(j.payload.despesas);
  });
}

function carregarOrcamentos(despesas){
  fetch(API_URL,{
    method:"POST", headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({ action:"getBudget" })
  })
  .then(r=>r.json()).then(j=>{
    montarTabela(despesas,j.payload);
  });
}

function montarTabela(despesas, orcs){
  const map={};
  despesas.forEach(d=>map[d[2]]=(map[d[2]]||0)+Number(d[1]));
  tabOrcamento.innerHTML="";
  orcs.forEach(o=>{
    const g=map[o[0]]||0, p=(g/o[1])*100||0;
    let cls=p<70?"ok":p<90?"warn":"bad";
    tabOrcamento.innerHTML+=`
      <tr class="${cls}">
        <td>${o[0]}</td>
        <td>R$ ${g.toFixed(2)}</td>
        <td>R$ ${o[1].toFixed(2)}</td>
        <td>${p.toFixed(0)}%</td>
      </tr>`;
  });
}

/* ================= ORCAMENTO ================= */
function salvarOrcamento(){
  fetch(API_URL,{
    method:"POST", headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({
      action:"saveBudget",
      natureza:orcNatureza.value,
      valor:+orcValor.value
    })
  })
  .then(r=>r.json()).then(j=>{
    alert(j.payload||"Orçamento salvo");
    carregarListaOrc();
  });
}

function carregarListaOrc(){
  fetch(API_URL,{
    method:"POST", headers:{"Content-Type":"text/plain"},
    body:JSON.stringify({ action:"getBudget" })
  })
  .then(r=>r.json()).then(j=>{
    listaOrc.innerHTML="";
    j.payload.forEach(o=>{
      listaOrc.innerHTML+=`<tr><td>${o[0]}</td><td>R$ ${o[1].toFixed(2)}</td></tr>`;
    });
  });
}

carregarListaOrc();
</script>

</body>
</html>
